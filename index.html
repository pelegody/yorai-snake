<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Snake</title>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; background:#0b0b0b; color:#eaeaea; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }

    .wrap { max-width: 1200px; margin: 0 auto; padding: 14px; }

    .topbar { display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .panel { background:#121212; border:1px solid #2a2a2a; border-radius:12px; padding:10px; }

    .row {
      display: grid;
      grid-template-columns: 3fr 1fr;
      gap: 10px;
      align-items: start;
    }
    @media (max-width: 900px) { .row { grid-template-columns: 1fr; } }

    .game-panel { padding: 10px; }
    canvas {
      background:#050505;
      border:1px solid #2a2a2a;
      border-radius:12px;
      display:block;
      width: 100%;
      height: auto;
      max-height: calc(100vh - 210px);
      aspect-ratio: 1 / 1;
      image-rendering: pixelated;
    }

    input, button {
      background:#1a1a1a; color:#eaeaea; border:1px solid #333; border-radius:10px;
      padding:10px 12px; font-size:14px;
    }
    button { cursor:pointer; }
    button:hover { border-color:#555; }

    .muted { color:#a8a8a8; font-size: 13px; }

    .scores { margin:0; padding-left: 18px; font-size: 13px; line-height: 1.3; }

    .kbd { padding:2px 6px; border:1px solid #333; border-bottom-width:2px; border-radius:6px; font-size:12px; }

    .panel.leaderboard { padding: 10px; max-height: 380px; overflow: auto; }

    .score-pill {
      display:inline-flex;
      align-items:baseline;
      gap:8px;
      padding:6px 10px;
      border:1px solid #2a2a2a;
      border-radius:999px;
      background: rgba(0,0,0,0.25);
    }
    .score-pill strong { font-size: 20px; }

    .overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.72);
      z-index: 999;
      padding: 16px;
    }
    .overlay.show { display: flex; }

    .overlay-card {
      width: min(520px, 100%);
      background: #121212;
      border: 1px solid #2a2a2a;
      border-radius: 16px;
      padding: 16px;
      text-align: center;
      box-shadow: 0 12px 40px rgba(0,0,0,0.6);
    }

    .final-score {
      font-size: 44px;
      font-weight: 800;
      margin: 10px 0 6px;
    }

    .overlay-actions {
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
      margin-top: 12px;
    }

    /* Hide top name input (we use center overlay instead) */
    #name { display:none; }
  </style>
</head>
<body>
<div class="wrap">

  <div class="topbar">
    <div class="panel">
      <div style="display:flex; gap:10px; align-items:center;">
        <strong>Snake</strong>
        <div class="score-pill">Score <strong id="score">0</strong></div>
      </div>
      <div class="muted">
        Controls:
        <span class="kbd">↑</span><span class="kbd">↓</span>
        <span class="kbd">←</span><span class="kbd">→</span>
        pause <span class="kbd">Space</span>, restart <span class="kbd">R</span>
      </div>
      <div class="muted">
        Bonus: 25% chance, lasts 10–20s, worth remaining seconds.
      </div>
    </div>

    <div class="panel" style="min-width: 280px;">
      <input id="name" />
      <button id="startBtn">Start</button>
      <button id="muteBtn">Mute</button>
      <div class="muted" id="netStatus">Loading…</div>
    </div>
  </div>

  <div style="height:10px;"></div>

  <div class="row">

    <div class="panel game-panel">
      <canvas id="c" width="720" height="720"></canvas>
      <div class="muted" id="bonusStatus" style="margin-top:8px;"></div>
    </div>

    <div class="panel leaderboard">
      <div style="display:flex; justify-content:space-between;">
        <strong>Top 5 (online)</strong>
        <button id="refreshBtn">Refresh</button>
      </div>
      <ol id="scores" class="scores"></ol>
    </div>

  </div>
</div>

<!-- GAME OVER -->
<div id="overlay" class="overlay">
  <div class="overlay-card">
    <div class="muted">Game over</div>
    <div class="final-score" id="finalScore">0</div>
    <div class="muted" id="finalNote">Submitting score…</div>
    <div class="overlay-actions">
      <button id="playAgainBtn">Play again</button>
      <button id="closeOverlayBtn">Close</button>
    </div>
  </div>
</div>

<!-- NAME PROMPT -->
<div id="nameOverlay" class="overlay">
  <div class="overlay-card">
    <div style="font-weight:700;font-size:18px;">Enter your name</div>
    <div class="muted" style="margin-top:6px;">Used for the leaderboard</div>

    <div style="margin-top:12px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
      <input id="namePromptInput" maxlength="16" placeholder="Name (max 16)" style="min-width:260px;">
      <button id="namePromptBtn">Continue</button>
    </div>
  </div>
</div>

<script>
(() => {
  const API_BASE = "/.netlify/functions";

  const elScore = document.getElementById("score");
  const elBonusStatus = document.getElementById("bonusStatus");
  const elScores = document.getElementById("scores");
  const elNetStatus = document.getElementById("netStatus");

  const startBtn = document.getElementById("startBtn");
  const refreshBtn = document.getElementById("refreshBtn");
  const muteBtn = document.getElementById("muteBtn");

  const overlay = document.getElementById("overlay");
  const finalScoreEl = document.getElementById("finalScore");
  const finalNoteEl = document.getElementById("finalNote");

  const playAgainBtn = document.getElementById("playAgainBtn");
  const closeOverlayBtn = document.getElementById("closeOverlayBtn");

  const nameOverlay = document.getElementById("nameOverlay");
  const namePromptInput = document.getElementById("namePromptInput");
  const namePromptBtn = document.getElementById("namePromptBtn");

  let session = null;

  // If your game code defines these, great. If not, we define safe defaults to avoid JS crashing.
  if (typeof window.tickCount === "undefined") window.tickCount = 0;
  if (typeof window.inputEvents === "undefined") window.inputEvents = [];

  // ---------- NAME STORAGE ----------
  const NAME_KEY = "snake:name";

  function sanitizeName(n) {
    return String(n || "")
      .replace(/[^a-zA-Z0-9 _.-]/g, "")
      .trim()
      .slice(0, 16);
  }

  function getSavedName() {
    return sanitizeName(localStorage.getItem(NAME_KEY) || "");
  }

  function setSavedName(n) {
    const name = sanitizeName(n) || "anon";
    localStorage.setItem(NAME_KEY, name);
    if (session) session.name = name;
    return name;
  }

  function showNamePrompt() {
    nameOverlay.classList.add("show");
    namePromptInput.value = getSavedName();
    startBtn.disabled = true;
    elNetStatus.textContent = "Enter name to continue…";
    setTimeout(() => namePromptInput.focus(), 0);
  }

  function hideNamePrompt() {
    nameOverlay.classList.remove("show");
    startBtn.disabled = false;
    elNetStatus.textContent = "Ready. Press Start.";
  }

  namePromptBtn.onclick = () => {
    setSavedName(namePromptInput.value);
    hideNamePrompt();
  };

  namePromptInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") namePromptBtn.click();
  });

  // ---------- API ----------
  async function apiGet(path) {
    const r = await fetch(API_BASE + path, { cache: "no-store" });
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    return r.json();
  }
  async function apiPost(path, body) {
    const r = await fetch(API_BASE + path, {
      method: "POST",
      headers: { "content-type": "application/json" },
      body: JSON.stringify(body),
    });
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    return r.json();
  }

  function renderTop5(list) {
    elScores.innerHTML = "";
    (list || []).forEach((it) => {
      const li = document.createElement("li");
      li.textContent = `${it.name} — ${it.score}`;
      elScores.appendChild(li);
    });
  }

  async function refreshTop5() {
    try {
      const d = await apiGet("/top5");
      renderTop5(d.top5 || []);
    } catch (e) {
      // keep UI alive even if backend is down
      elNetStatus.textContent = "Leaderboard error: " + (e?.message || "unknown");
    }
  }

  async function newSession() {
    const name = getSavedName() || "anon";
    const s = await apiPost("/new", { name });
    session = s;
    session.name = name;
    elNetStatus.textContent = "Session ready.";
    return s;
  }

  // Optional: call this from your real game-over logic
  async function submitScoreSafe() {
    try {
      if (!session) return;
      const res = await apiPost("/submit", {
        name: session.name,
        sessionId: session.sessionId,
        sig: session.sig,
        seed: session.seed,
        tickCount: window.tickCount,
        inputs: window.inputEvents
      });

      if (res.ok) {
        finalNoteEl.textContent = "Verified score: " + res.verifiedScore;
        await refreshTop5();
      } else {
        finalNoteEl.textContent = "Submit rejected: " + (res.reason || "unknown");
      }
    } catch (e) {
      finalNoteEl.textContent = "Submit failed: " + (e?.message || "unknown");
    }
  }

  // ---------- BUTTONS ----------
  refreshBtn.onclick = () => refreshTop5();

  // If your real game code already sets startBtn.onclick, KEEP IT.
  // This fallback only creates a session and updates status.
  if (!startBtn.onclick) {
    startBtn.onclick = async () => {
      try {
        elNetStatus.textContent = "Creating session…";
        await newSession();
        elNetStatus.textContent = "Session ready. (Paste your game code to start playing)";
      } catch (e) {
        elNetStatus.textContent = "Failed to start session.";
      }
    };
  }

  // mute placeholder (your full game had audio logic; keep yours if present)
  let muted = false;
  muteBtn.onclick = () => {
    muted = !muted;
    muteBtn.textContent = muted ? "Unmute" : "Mute";
  };

  // ---------- INIT ----------
  const saved = getSavedName();
  if (saved) {
    hideNamePrompt();
  } else {
    showNamePrompt();
  }

  elBonusStatus.textContent = "";
  refreshTop5();
})();
</script>
</body>
</html>
